# .stagefreight.yml — Homelab Self-Hosted Fork
#
# Who: Homelab users running customized versions of popular self-hosted apps.
#      You forked Immich/Jellyfin/Paperless to add a feature or patch a bug,
#      and you want it to stay current without manual rebasing every week.
# What: Fork tracking with auto-sync, auto-rebuild on upstream changes,
#       YOLO auto-merge because you're the only user and you trust the process.
# Build: Upstream's Dockerfile with your patches. Pushed to your personal registry.
# Why: The homelab dream — fork it, patch it, forget it. StageFreight keeps
#      it current and rebuilds it automatically.

version: 1

fork:
  upstream: github.com/immich-app/immich
  strategy: rebase
  auto_sync: true

release:
  notes: true

docker:
  platforms: [linux/amd64, linux/arm64]
  registries:
    - url: docker.io
      path: sofmeright/immich-custom
      tags: ["{version}-custom", latest]
  rebuild:
    schedule: daily
    on_base_update: true
    notify: true

security:
  scan: true
  audit_deps: true

dev:
  env:
    DB_URL: postgres://dev:dev@db:5432/immich_dev
    REDIS_HOSTNAME: cache
  services:
    db:
      image: docker.io/library/postgres:17-alpine
      env: { POSTGRES_USER: dev, POSTGRES_PASSWORD: dev, POSTGRES_DB: immich_dev }
      healthcheck: { test: "pg_isready -U dev", interval: 5s }
    cache:
      image: docker.io/library/redis:7-alpine
  ports: ["2283:2283"]
  test:
    startup: { timeout: 60s, depends_on: [db, cache] }
    healthchecks:
      - { name: http, type: http, url: "http://localhost:2283/api/server-info/ping", expect_status: 200 }

yolo: true                            # auto-merge StageFreight MRs — I trust it
